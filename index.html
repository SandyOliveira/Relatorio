<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Relatório de Aulas</title>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f5f7fb;
      margin: 0;
      padding: 40px 0;
      display: flex;
      justify-content: center;
    }

    .container {
      background: #fff;
      width: 800px;
      padding: 30px 40px;
      border-radius: 16px;
      box-shadow: 0 6px 25px rgba(0,0,0,0.08);
    }

    h1 {
      color: #4B4BFF;
      text-align: center;
      margin-bottom: 10px;
    }

    h2 {
      color: #333;
      margin-top: 30px;
      border-left: 4px solid #4B4BFF;
      padding-left: 10px;
    }

    .aluna-info {
      text-align: center;
      margin-bottom: 25px;
      color: #555;
    }

    .creditos {
      background: #e8f5e9;
      color: #2e7d32;
      font-weight: bold;
      display: inline-block;
      padding: 8px 15px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .modulo {
      background: #fafafa;
      border-radius: 12px;
      padding: 15px 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      transition: 0.3s;
    }

    .modulo:hover {
      background: #f0f3ff;
    }

    .modulo-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modulo-nome {
      font-weight: bold;
      font-size: 18px;
      color: #3f51b5;
    }

    .status {
      font-size: 13px;
      padding: 4px 10px;
      border-radius: 6px;
      color: white;
    }

    .status.atual { background: #4b4bff; }
    .status.concluido { background: #43a047; }

    .aulas-lista {
      margin-top: 10px;
      padding-left: 20px;
    }

    .aula {
      background: #f9f9f9;
      border-left: 3px solid #4b4bff;
      padding: 10px 15px;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .aula-title {
      color: #1a237e;
      font-weight: bold;
    }

    .aula-info {
      color: #333;
    }

    .nenhuma-aula {
      color: #888;
      font-style: italic;
      padding-left: 20px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Relatório de Aulas</h1>
    <div class="aluna-info">
      <h3 id="aluna">Aluna:</h3>
      <div class="creditos">Créditos disponíveis: <span id="creditos">0</span></div>
    </div>

    <h2>Progresso por Módulo</h2>
    <div id="modulosContainer"></div>
  </div>

  <script>
    // 🔹 Configuração Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBoSaXfiu4H5OgNwBprq57zuKrgoGcQkZc",
      authDomain: "contando-69c3b.firebaseapp.com",
      projectId: "contando-69c3b",
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const params = new URLSearchParams(window.location.search);
    const alunoId = params.get("aluno") || "vitoriazanzoni";

    async function carregarRelatorio() {
      const alunoRef = db.collection("alunos").doc(alunoId);
      const docAluno = await alunoRef.get();

      if (!docAluno.exists) {
        document.getElementById("aluna").innerText = "Aluno não encontrado.";
        return;
      }

      const dados = docAluno.data();
      document.getElementById("aluna").innerText = "Aluna: " + dados.nome;
      document.getElementById("creditos").innerText = dados.creditosTotais || 0;

      const moduloAtual = dados.modulo;
      const modContainer = document.getElementById("modulosContainer");
      modContainer.innerHTML = "";

      const modulosSnap = await alunoRef.collection("modulos").get();

      if (modulosSnap.empty) {
        modContainer.innerHTML = "<p>Nenhum módulo registrado ainda.</p>";
        return;
      }

      // Organizar módulos por nome (ordem alfabética/natural)
      const modulosOrdenados = modulosSnap.docs.sort((a, b) => a.id.localeCompare(b.id, 'pt', { numeric: true }));

      for (const moduloDoc of modulosOrdenados) {
        const moduloNome = moduloDoc.id;
        const dadosModulo = moduloDoc.data();
        const aulasSnap = await alunoRef.collection("modulos").doc(moduloNome).collection("aulas").get();

        const div = document.createElement("div");
        div.className = "modulo";

        const header = document.createElement("div");
        header.className = "modulo-header";

        const nomeEl = document.createElement("div");
        nomeEl.className = "modulo-nome";
        nomeEl.innerText = moduloNome;

        const status = document.createElement("div");
        status.className = "status " + (moduloNome === moduloAtual ? "atual" : "concluido");
        status.innerText = moduloNome === moduloAtual ? "Em andamento" : "Concluído";

        header.appendChild(nomeEl);
        header.appendChild(status);
        div.appendChild(header);

        // Listar aulas
        if (aulasSnap.empty) {
          const p = document.createElement("p");
          p.className = "nenhuma-aula";
          p.innerText = "Nenhuma aula registrada neste módulo.";
          div.appendChild(p);
        } else {
          const ul = document.createElement("div");
          ul.className = "aulas-lista";

          aulasSnap.forEach(aula => {
            const a = aula.data();
            const aulaDiv = document.createElement("div");
            aulaDiv.className = "aula";
            aulaDiv.innerHTML = `
              <div class="aula-title">${aula.id} - ${a.data} (${a.horario})</div>
              <div class="aula-info">Conteúdo: ${a.conteudo}</div>
            `;
            ul.appendChild(aulaDiv);
          });

          div.appendChild(ul);
        }

        modContainer.appendChild(div);
      }
    }

    carregarRelatorio();
  </script>
</body>
</html>
